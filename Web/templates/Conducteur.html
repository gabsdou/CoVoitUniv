<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Ma carte Leaflet locale</title>
<!-- Feuille de style Leaflet -->
<link rel="stylesheet" href="./leaflet/leaflet.css">

<!-- Feuille de style Leaflet Routing Machine -->
<link rel="stylesheet" href="./leaflet-routing-machine/leaflet-routing-machine.css">


  <style>
    /* Donne une taille à la div qui contiendra la carte */
    #map {
      width: 700px;
      height: 600px;
    }
    /* Conteneur pour les instructions */
    #options-passagers {
      float: left;
      width: 30%;
      height: 600px;
      box-sizing: border-box;
      padding: 10px;
      overflow-y: auto;
      border-left: 1px solid #ccc;
    }
    .leaflet-routing-container {
      display: none !important;
    }
    .destination-item {
      margin-bottom: 10px;
    }
    .active-button {
      background-color: #4CAF50; /* vert */
      color: white;
    }
    .inactive-button {
      background-color: #f0f0f0; /* gris clair */
      color: black;
    }
  </style>
</head>
<body>

<h1>Ma carte OpenStreetMap avec Leaflet (en local)</h1>

<!-- Conteneur pour la carte -->
<div id="map"></div>

<div id="options-passagers">
  <h2>Destinations</h2>
  <div id="destinations-list"></div>
</div>

</div>


<!-- Script Leaflet -->
<script src="./leaflet/leaflet.js"></script>

<!-- Script Leaflet Routing Machine -->
<script src="./leaflet-routing-machine/leaflet-routing-machine.js"></script>


<!-- Script d'initialisation de la carte -->
<script>
  // Initialiser la carte sur Paris, avec un zoom de 13
  var map = L.map('map').setView([48.8566, 2.3522], 10);

  // Ajouter le calque OSM
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/copyright">'
      + 'OpenStreetMap</a> contributors'
  }).addTo(map);
  // Exemple de tableau de lat-lng formant un chemin

  var routingControl = L.Routing.control({
    // Points de départ et d’arrivée (waypoints)
    waypoints: [
      L.latLng(48.86234, 2.34472),  // Paris
      L.latLng(48.956432, 2.338543)   // Aéroport CDG
    ],

    // (Optionnel) Autoriser le recalcul en glissant les marqueurs
    routeWhileDragging: true,
    
    
    //IMPORTANT
    // (Optionnel) Préciser un service de routage personnalisé (OSRM, ORS, etc.)
    /*router: L.Routing.osrmv1({
    serviceUrl: 'https://router.project-osrm.org/route/v1/driving'
    })*/

  }).addTo(map);

  {% for route in routes %}
            // Récupérer les coordonnées des trajets et afficher une polyline
            var destination = [
                [{{ route['name'] }}], // Départ
                [{{ route['route'] }}]  // Arrivée
            ];
  {% endfor %}
  var destinations = [
  { name: 'Aubervilliers',   coords: [48.91438, 2.38206],  active: false },
      { name: 'Dugny',        coords: [48.95311, 2.41364],  active: false },
      { name: 'Aubervilliers',   coords: [48.91438, 2.38206],  active: false },
      { name: 'Gonesse',    coords: [48.9863, 2.4489], active: false },
      
    ];

    function populateDestinationsList() {
      var container = document.getElementById('destinations-list');
      container.innerHTML = ''; // Nettoyer si besoin

      destination.forEach(function(dest, index) {
        // Conteneur pour chaque destination
        var div = document.createElement('div');
        div.className = 'destination-item';

        // Nom de la destination
        var spanName = document.createElement('span');
        spanName.textContent = dest.name + ' ';

        // Bouton toggle
        var button = document.createElement('button');
        button.textContent = dest.active ? 'Retirer' : 'Ajouter';

        // Style du bouton selon l'état actif/inactif
        button.className = dest.active ? 'active-button' : 'inactive-button';

        // Au clic, on bascule "dest.active"
        button.addEventListener('click', function() {
          // Inverser l'état
          dest.active = !dest.active;
          // Mettre à jour le texte et le style
          button.textContent = dest.active ? 'Retirer' : 'Ajouter';
          button.className = dest.active ? 'active-button' : 'inactive-button';

          // Recalcule le chemin
          updateRoute();
        });

        div.appendChild(spanName);
        div.appendChild(button);
        container.appendChild(div);
      });
    }

    ////////////////////////////////
    // 5) Construction du nouvel itinéraire
    ////////////////////////////////
    //   On conserve le point A (index 0) et B (dernier),
    //   et on ajoute les points "active" au milieu.
    ////////////////////////////////
    function updateRoute() {
  // 1. Récupérer les waypoints existants
  var currentWaypoints = routingControl.getWaypoints();

  // 2. Conserver le départ et l'arrivée
  var startLatLng = currentWaypoints[0].latLng; 
  var endLatLng = currentWaypoints[currentWaypoints.length - 1].latLng;

  // 3. Construire un tableau de waypoints
  var newWaypoints = [];
  newWaypoints.push(startLatLng); // Départ
  destination.forEach(function(dest) {
    if (dest.active) {
      newWaypoints.push(L.latLng(dest.route)); // Points intermédiaires actifs
    }
  });
  newWaypoints.push(endLatLng); // Arrivée

  // 4. Appliquer les nouveaux waypoints au contrôle de routage
  routingControl.setWaypoints(newWaypoints);

  // 5. Ajuster la vue pour afficher tout le trajet
  var bounds = L.latLngBounds(newWaypoints); // Calcul des bornes
  map.fitBounds(bounds); // Ajuste le zoom pour inclure toutes les bornes
}


    // Au chargement, on remplit la liste de destinations
    populateDestinationsList();
    // updateRoute() n'est pas nécessaire au démarrage
    // car on a déjà le Paris->CDG initial


</script>


</body>
</html>
